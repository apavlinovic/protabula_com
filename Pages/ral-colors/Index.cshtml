@page "/ral-colors/{color:regex(^(yellow|orange|red|green|blue|violet|grey|brown|white|black|pink|rose|beige)$)?}"
@using Microsoft.AspNetCore.Mvc.Localization
@using System.Globalization
@using protabula_com.Models
@inject IViewLocalizer Localizer
@model RalColorsModel
@{
    var currentCulture = CultureInfo.CurrentUICulture.Name;
    var request = ViewContext.HttpContext.Request;
    var baseUrl = $"{request.Scheme}://{request.Host}";

    var rootColorName = Model.SelectedRootColor.HasValue
        ? Localizer[$"RootColor{Model.SelectedRootColor}"].Value
        : null;
    var rootColorSlug = Model.SelectedRootColor?.ToString().ToLowerInvariant();

    // Page title: "RAL Colors" or "RAL Grey Colors"
    ViewData["Title"] = Model.SelectedRootColor.HasValue && rootColorName != null
        ? Localizer["TitleFiltered", rootColorName].Value
        : Localizer["Title"].Value;

    ViewData["MetaDescription"] = Model.SelectedRootColor.HasValue && rootColorName != null
        ? Localizer["MetaDescriptionFiltered", rootColorName].Value
        : Localizer["MetaDescription"].Value;

    var baseTitle = Localizer["Title"].Value;
    var breadcrumbs = new List<(string, string?, object?)>();
    if (Model.SelectedRootColor.HasValue)
    {
        breadcrumbs.Add((baseTitle, "/ral-colors/Index", new Dictionary<string, string> { ["culture"] = currentCulture }));
        breadcrumbs.Add((rootColorName!, null, null));
    }
    else
    {
        breadcrumbs.Add((baseTitle, null, null));
    }
    ViewData["Breadcrumbs"] = breadcrumbs;
}

@section Head {
    <script type="application/ld+json">
    {
        "@@context": "https://schema.org",
        "@@type": "CollectionPage",
        "name": "@ViewData["Title"]",
        "description": "@ViewData["MetaDescription"]",
        "url": "@baseUrl/@currentCulture/ral-colors@(rootColorSlug != null ? $"/{rootColorSlug}" : "")",
        "isPartOf": {
            "@@type": "WebSite",
            "name": "Protabula",
            "url": "@baseUrl"
        },
        "about": {
            "@@type": "Thing",
            "name": "@ViewData["Title"]"
        },
        "numberOfItems": @Model.Colors.Count
    }
    </script>
}

<h1>@ViewData["Title"]</h1>
<p>@Localizer["Intro"]</p>

@if (Model.AvailableRootColors.Count > 1)
{
    <nav class="root-color-filters" aria-label="@Localizer["FilterByRootColor"]">
        <a href="/@currentCulture/ral-colors"
           class="filter-chip @(Model.SelectedRootColor == null ? "active" : "")">
            @Localizer["FilterAll"]
        </a>
        @foreach (var rootColor in Model.AvailableRootColors)
        {
            var chipSlug = rootColor.ToString().ToLowerInvariant();
            <a asp-page="/ral-colors/Index"
               asp-route-culture="@currentCulture"
               asp-route-color="@chipSlug"
               class="filter-chip @(Model.SelectedRootColor == rootColor ? "active" : "")">
                @Localizer[$"RootColor{rootColor}"]
            </a>
        }
    </nav>
}

<partial name="Shared/_ColorFilter" />

@{
    var groups = Model.Colors
    .OrderBy(color => color.Category)
    .GroupBy(color => color.Category)
    .ToList();
}
@for (var index = 0; index < groups.Count; index++)
{
    var group = groups[index];
    <section class="color-section">
        <h2>@Localizer[$"Category{group.Key}"]</h2>
        <div class="color-grid">
            @foreach (var color in group)
            {
                <a class="color-tile @(color.NeedsDarkText ? "dark" : "")" style="background-color: @color.Hex;"
                    asp-page="/ral-colors/Details" asp-route-culture="@RouteData.Values["culture"]"
                    asp-route-colorIdentifier="@color.Slug"
                    data-name="@color.Name?.ToLowerInvariant()"
                    data-name-de="@color.NameDe?.ToLowerInvariant()"
                    data-number="@color.Number.ToLowerInvariant()">

                    <span class="ral">RAL</span>
                    <h3 class="number">@color.Number</h3>

                    @{
                        var localizedName = color.GetLocalizedName(currentCulture);
                    }
                    @if (!string.IsNullOrEmpty(localizedName))
                    {
                        <span class="name">@localizedName</span>
                    }
                </a>
            }
        </div>
    </section>
    @if (index < groups.Count - 1)
    {
        <hr class="section-divider" />
    }
}

<p id="noResults" class="text-secondary hidden">@Localizer["NoResults"]</p>

@section Scripts {
    <script>
        function filterColors(query) {
            const searchTerm = query.toLowerCase().trim();
            const tiles = document.querySelectorAll('.color-tile');
            const sections = document.querySelectorAll('.color-section');
            const dividers = document.querySelectorAll('.section-divider');
            const noResults = document.getElementById('noResults');

            let totalVisible = 0;

            tiles.forEach(tile => {
                const name = tile.dataset.name || '';
                const nameDe = tile.dataset.nameDe || '';
                const number = tile.dataset.number || '';

                const matches = searchTerm === '' ||
                    name.includes(searchTerm) ||
                    nameDe.includes(searchTerm) ||
                    number.includes(searchTerm);

                tile.style.display = matches ? '' : 'none';
                if (matches) totalVisible++;
            });

            // Hide sections with no visible items
            sections.forEach(section => {
                const visibleTiles = section.querySelectorAll('.color-tile[style=""], .color-tile:not([style])');
                const hasVisible = Array.from(section.querySelectorAll('.color-tile')).some(t => t.style.display !== 'none');
                section.style.display = hasVisible ? '' : 'none';
            });

            // Hide dividers between hidden sections
            dividers.forEach(divider => {
                const prevSection = divider.previousElementSibling;
                const nextSection = divider.nextElementSibling;
                const showDivider = prevSection?.style.display !== 'none' && nextSection?.style.display !== 'none';
                divider.style.display = showDivider ? '' : 'none';
            });

            // Show no results message
            noResults.classList.toggle('hidden', !(totalVisible === 0 && searchTerm !== ''));
        }
    </script>
}
