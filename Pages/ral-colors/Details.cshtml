@page "/ral-colors/{colorIdentifier}"
@using Microsoft.AspNetCore.Mvc.Localization
@using protabula_com.Models
@model RalColorDetailsModel
@inject IViewLocalizer Localizer
@{
    var colorTitle = string.IsNullOrEmpty(Model.Color.Name)
        ? $"RAL {Model.Color.Number}"
        : $"RAL {Model.Color.Number} {Model.Color.Name}";
    ViewData["Title"] = colorTitle;
}

<a asp-page="/ral-colors/Index" class="btn btn-ghost" asp-route-culture="@RouteData.Values["culture"]">
    &larr; @Localizer["BackToColors"]
</a>

<h1>@colorTitle</h1>

<p class="text-secondary mb-lg">
    @{
        var paletteName = Localizer[$"Palette{Model.Color.Category}"].Value;
    }
    @if (!string.IsNullOrEmpty(Model.Color.Name) && Model.Color.RootColor != RootColor.Unknown)
    {
        @Localizer["IntroWithNameAndRoot", Model.Color.Number, Model.Color.Name, Localizer[$"RootColor{Model.Color.RootColor}"].Value, paletteName, Model.Color.Hex]
    }
    else if (!string.IsNullOrEmpty(Model.Color.Name))
    {
        @Localizer["IntroWithName", Model.Color.Number, Model.Color.Name, paletteName, Model.Color.Hex]
    }
    else if (Model.Color.RootColor != RootColor.Unknown)
    {
        @Localizer["IntroWithRoot", Model.Color.Number, Localizer[$"RootColor{Model.Color.RootColor}"].Value, paletteName, Model.Color.Hex]
    }
    else
    {
        @Localizer["IntroBasic", Model.Color.Number, paletteName, Model.Color.Hex]
    }
</p>

<div class="color @(Model.Color.NeedsDarkText ? "dark" : "")" style="background-color: @Model.Color.Hex;"
     role="button" tabindex="0"
     onclick="openColorPreview()" onkeydown="handleColorKeydown(event)"
     title="@Localizer["ClickToPreview"]">
    <span class="color-preview-hint">@Localizer["ClickToPreview"]</span>
</div>

<!-- Full-page color preview modal -->
<div id="colorPreview" class="color-preview-overlay" style="background-color: #FFFFFF;"
     role="dialog" aria-modal="true" aria-labelledby="colorPreviewTitle"
     onclick="closeColorPreview(event)">
    <div class="color-preview-content">
        <h2 id="colorPreviewTitle" class="visually-hidden">@Localizer["ColorPreviewTitle"]</h2>
        <button class="color-preview-close" onclick="closeColorPreview(event)" aria-label="@Localizer["Close"]">&times;</button>
        <div class="color-preview-swatch" style="background-color: @Model.Color.Hex;">
            @* <div class="color-preview-info @(Model.Color.NeedsDarkText ? "dark" : "")"> *@
            @*     <span>RAL @Model.Color.Number</span> *@
            @*     @if (!string.IsNullOrEmpty(Model.Color.Name)) *@
            @*     { *@
            @*         <span>@Model.Color.Name</span> *@
            @*     } *@
            @* </div> *@
        </div>
    </div>
    <div class="color-preview-controls">
        <button class="bg-option active" data-bg="#FFFFFF" onclick="changePreviewBg('#FFFFFF', this)">
            <span class="bg-option-swatch" style="background-color: #FFFFFF;"><span style="background-color: @Model.Color.Hex;"></span></span>
            <span class="bg-option-label">@Localizer["BgWhite"]</span>
        </button>
        <button class="bg-option" data-bg="#E0E0E0" onclick="changePreviewBg('#E0E0E0', this)">
            <span class="bg-option-swatch" style="background-color: #E0E0E0;"><span style="background-color: @Model.Color.Hex;"></span></span>
            <span class="bg-option-label">@Localizer["BgLightGrey"]</span>
        </button>
        <button class="bg-option" data-bg="#9E9E9E" onclick="changePreviewBg('#9E9E9E', this)">
            <span class="bg-option-swatch" style="background-color: #9E9E9E;"><span style="background-color: @Model.Color.Hex;"></span></span>
            <span class="bg-option-label">@Localizer["BgGrey"]</span>
        </button>
        <button class="bg-option" data-bg="#424242" onclick="changePreviewBg('#424242', this)">
            <span class="bg-option-swatch" style="background-color: #424242;"><span style="background-color: @Model.Color.Hex;"></span></span>
            <span class="bg-option-label">@Localizer["BgDarkGrey"]</span>
        </button>
        <button class="bg-option" data-bg="#000000" onclick="changePreviewBg('#000000', this)">
            <span class="bg-option-swatch" style="background-color: #000000;"><span style="background-color: @Model.Color.Hex;"></span></span>
            <span class="bg-option-label">@Localizer["BgBlack"]</span>
        </button>
    </div>
</div>

<table class="color-details mb-xl">
    <tr>
        <th>@Localizer["LabelName"]</th>
        <td>@(string.IsNullOrEmpty(Model.Color.Name) ? "—" : Model.Color.Name)</td>
    </tr>
    <tr>
        <th>@Localizer["LabelNameDe"]</th>
        <td>@(string.IsNullOrEmpty(Model.Color.NameDe) ? "—" : Model.Color.NameDe)</td>
    </tr>
    <tr>
        <th>@Localizer["LabelRootColor"]</th>
        <td>
            @if (Model.Color.RootColor != RootColor.Unknown)
            {
                <span class="badge badge-@Model.Color.RootColor.ToString().ToLowerInvariant()">
                    @Localizer[$"RootColor{Model.Color.RootColor}"]
                </span>
            }
            else
            {
                <span>—</span>
            }
        </td>
    </tr>
    <tr>
        <th>@Localizer["LabelHex"]</th>
        <td><code>@Model.Color.Hex</code></td>
    </tr>
</table>

<section class="contrast-section mt-2xl">
    <h2>@Localizer["ContrastComparison"]</h2>
    <div class="contrast-grid">
        <div class="contrast-bg" style="background-color: #FFFFFF;"
             role="button" tabindex="0"
             onclick="openColorPreviewWithBg('#FFFFFF')" onkeydown="handleContrastKeydown(event, '#FFFFFF')">
            <div class="contrast-swatch" style="background-color: @Model.Color.Hex;"></div>
            <span class="contrast-label">@Localizer["BgWhite"]</span>
        </div>
        <div class="contrast-bg" style="background-color: #E0E0E0;"
             role="button" tabindex="0"
             onclick="openColorPreviewWithBg('#E0E0E0')" onkeydown="handleContrastKeydown(event, '#E0E0E0')">
            <div class="contrast-swatch" style="background-color: @Model.Color.Hex;"></div>
            <span class="contrast-label">@Localizer["BgLightGrey"]</span>
        </div>
        <div class="contrast-bg" style="background-color: #9E9E9E;"
             role="button" tabindex="0"
             onclick="openColorPreviewWithBg('#9E9E9E')" onkeydown="handleContrastKeydown(event, '#9E9E9E')">
            <div class="contrast-swatch" style="background-color: @Model.Color.Hex;"></div>
            <span class="contrast-label">@Localizer["BgGrey"]</span>
        </div>
        <div class="contrast-bg" style="background-color: #424242;"
             role="button" tabindex="0"
             onclick="openColorPreviewWithBg('#424242')" onkeydown="handleContrastKeydown(event, '#424242')">
            <div class="contrast-swatch" style="background-color: @Model.Color.Hex;"></div>
            <span class="contrast-label">@Localizer["BgDarkGrey"]</span>
        </div>
        <div class="contrast-bg" style="background-color: #000000;"
             role="button" tabindex="0"
             onclick="openColorPreviewWithBg('#000000')" onkeydown="handleContrastKeydown(event, '#000000')">
            <div class="contrast-swatch" style="background-color: @Model.Color.Hex;"></div>
            <span class="contrast-label">@Localizer["BgBlack"]</span>
        </div>
    </div>
</section>

<hr />

@if (Model.SimilarColors.Classic.Any() || Model.SimilarColors.DesignPlus.Any() || Model.SimilarColors.Effect.Any())
{
    <section class="similar-colors mt-xl">
        <h2>@Localizer["SimilarColors"]</h2>

        @if (Model.SimilarColors.Classic.Any())
        {
            <h3>@Localizer["CategoryClassic"]</h3>
            <div class="similar-grid">
                @foreach (var similar in Model.SimilarColors.Classic)
                {
                    <partial name="_ColorTile" model="similar.Color" />
                }
            </div>
        }

        @if (Model.SimilarColors.DesignPlus.Any())
        {
            <h3>@Localizer["CategoryDesignPlus"]</h3>
            <div class="similar-grid">
                @foreach (var similar in Model.SimilarColors.DesignPlus)
                {
                    <partial name="_ColorTile" model="similar.Color" />
                }
            </div>
        }

        @if (Model.SimilarColors.Effect.Any())
        {
            <h3>@Localizer["CategoryEffect"]</h3>
            <div class="similar-grid">
                @foreach (var similar in Model.SimilarColors.Effect)
                {
                    <partial name="_ColorTile" model="similar.Color" />
                }
            </div>
        }
    </section>
}

@section Scripts {
    <script>
        let lastFocusedElement = null;

        function openColorPreview() {
            lastFocusedElement = document.activeElement;
            const modal = document.getElementById('colorPreview');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            // Focus the close button
            modal.querySelector('.color-preview-close').focus();
        }

        function openColorPreviewWithBg(bgColor) {
            document.getElementById('colorPreview').style.backgroundColor = bgColor;
            document.querySelectorAll('.bg-option').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.bg === bgColor);
            });
            openColorPreview();
        }

        function closeColorPreview(event) {
            if (event.target.classList.contains('color-preview-overlay') ||
                event.target.classList.contains('color-preview-close')) {
                document.getElementById('colorPreview').classList.remove('active');
                document.body.style.overflow = '';
                if (lastFocusedElement) lastFocusedElement.focus();
            }
        }

        function closeModal() {
            document.getElementById('colorPreview').classList.remove('active');
            document.body.style.overflow = '';
            if (lastFocusedElement) lastFocusedElement.focus();
        }

        function changePreviewBg(color, button) {
            document.getElementById('colorPreview').style.backgroundColor = color;
            document.querySelectorAll('.bg-option').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            event.stopPropagation();
        }

        function handleColorKeydown(event) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                openColorPreview();
            }
        }

        function handleContrastKeydown(event, bgColor) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                openColorPreviewWithBg(bgColor);
            }
        }

        // Focus trap for modal
        document.getElementById('colorPreview').addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                const focusable = this.querySelectorAll('button');
                const first = focusable[0];
                const last = focusable[focusable.length - 1];

                if (e.shiftKey && document.activeElement === first) {
                    e.preventDefault();
                    last.focus();
                } else if (!e.shiftKey && document.activeElement === last) {
                    e.preventDefault();
                    first.focus();
                }
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
}
