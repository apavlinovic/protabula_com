@page "/ral-colors/{colorIdentifier}"
@using Microsoft.AspNetCore.Mvc.Localization
@using protabula_com.Models
@using System.Globalization
@model RalColorDetailsModel
@inject IViewLocalizer Localizer
@{
    var colorTitle = string.IsNullOrEmpty(Model.Color.Name)
        ? $"RAL {Model.Color.Number}"
        : $"RAL {Model.Color.Number} {Model.Color.Name}";

    // SEO-optimized title
    ViewData["Title"] = $"{colorTitle} - {Localizer["TitleSuffix"].Value}";

    // Meta description using ColorFormats
    var rgb = Model.Formats?.Rgb ?? (byte.MinValue, byte.MinValue, byte.MinValue);
    var cmyk = Model.Formats?.Cmyk ?? (0, 0, 0, 0);
    ViewData["MetaDescription"] = string.IsNullOrEmpty(Model.Color.Name)
        ? Localizer["MetaDescriptionBasic", Model.Color.Number, Model.Color.Hex, rgb.R, rgb.G, rgb.B, cmyk.C, cmyk.M, cmyk.Y, cmyk.K].Value
        : Localizer["MetaDescriptionWithName", Model.Color.Number, Model.Color.Name, Model.Color.Hex, rgb.R, rgb.G, rgb.B, cmyk.C, cmyk.M, cmyk.Y, cmyk.K].Value;

    // For structured data
    var currentCulture = CultureInfo.CurrentUICulture.Name;
    var request = ViewContext.HttpContext.Request;
    var baseUrl = $"{request.Scheme}://{request.Host}";
    var currentUrl = $"{baseUrl}/{currentCulture}/ral-colors/{Model.Color.Slug}";

    // Breadcrumbs - include category
    var categorySlug = Model.Color.Category switch
    {
        RalCategory.Classic => "classic",
        RalCategory.DesignPlus => "design-plus",
        RalCategory.Effect => "effect",
        _ => "classic"
    };
    var categoryName = Localizer[$"Category{Model.Color.Category}"].Value;

    ViewData["Breadcrumbs"] = new List<(string, string?, object?)>
    {
        (Localizer["BreadcrumbColors"].Value, "/ral-colors/Index", new Dictionary<string, string> { ["culture"] = currentCulture }),
        (categoryName, "/ral-colors/Category", new Dictionary<string, string> { ["culture"] = currentCulture, ["category"] = categorySlug }),
        (colorTitle, null, null)
    };

    // OG Image for social sharing
    ViewData["OgImage"] = $"{baseUrl}/images/ral-colors/{Model.Color.Slug}.jpg";
}

@section Head {
    <script type="application/ld+json">
    {
        "@@context": "https://schema.org",
        "@@type": "BreadcrumbList",
        "itemListElement": [
            {
                "@@type": "ListItem",
                "position": 1,
                "name": "@Localizer["BreadcrumbHome"].Value",
                "item": "@baseUrl/@currentCulture"
            },
            {
                "@@type": "ListItem",
                "position": 2,
                "name": "@Localizer["BreadcrumbColors"].Value",
                "item": "@baseUrl/@currentCulture/ral-colors"
            },
            {
                "@@type": "ListItem",
                "position": 3,
                "name": "@colorTitle"
            }
        ]
    }
    </script>
    <script type="application/ld+json">
    {
        "@@context": "https://schema.org",
        "@@type": "Product",
        "name": "@colorTitle",
        "description": "@ViewData["MetaDescription"]",
        "color": "@Model.Color.Name",
        "sku": "RAL-@Model.Color.Number",
        "brand": {
            "@@type": "Brand",
            "name": "RAL"
        },
        "additionalProperty": [
            {
                "@@type": "PropertyValue",
                "name": "HEX",
                "value": "@Model.Color.Hex"
            },
            {
                "@@type": "PropertyValue",
                "name": "RGB",
                "value": "rgb(@rgb.R, @rgb.G, @rgb.B)"
            },
            {
                "@@type": "PropertyValue",
                "name": "Category",
                "value": "@Model.Color.Category"
            }
        ]
    }
    </script>
}


<h1>@colorTitle</h1>

<p class="text-secondary mb-lg">
    @{
        var paletteName = Localizer[$"Palette{Model.Color.Category}"].Value;
    }
    @if (!string.IsNullOrEmpty(Model.Color.Name) && Model.Color.RootColor != RootColor.Unknown)
    {
        @Localizer["IntroWithNameAndRoot", Model.Color.Number, Model.Color.Name, Localizer[$"RootColor{Model.Color.RootColor}"].Value, paletteName, Model.Color.Hex]
    }
    else if (!string.IsNullOrEmpty(Model.Color.Name))
    {
        @Localizer["IntroWithName", Model.Color.Number, Model.Color.Name, paletteName, Model.Color.Hex]
    }
    else if (Model.Color.RootColor != RootColor.Unknown)
    {
        @Localizer["IntroWithRoot", Model.Color.Number, Localizer[$"RootColor{Model.Color.RootColor}"].Value, paletteName, Model.Color.Hex]
    }
    else
    {
        @Localizer["IntroBasic", Model.Color.Number, paletteName, Model.Color.Hex]
    }
</p>


<div class="color @(Model.Color.NeedsDarkText ? "dark" : "")" style="background-color: @Model.Color.Hex;"
     role="button" tabindex="0"
     onclick="openColorPreview()" onkeydown="handleColorKeydown(event)"
     title="@Localizer["ClickToPreview"]">
    <span class="color-preview-hint">@Localizer["ClickToPreview"]</span>
</div>

<section class="scene-preview-section mt-2xl">
    <h2>@Localizer["ScenePreview", Model.Color.Number]</h2>
    <p class="text-secondary">@Localizer["ScenePreviewDesc", Model.Color.Number]</p>
    <div class="scene-grid">
        <figure class="scene-preview">
            <img src="/images/ral-scenes/@(Model.Color.Slug)/front.jpg" alt="@Localizer["SceneFrontAlt", Model.Color.Number, Model.Color.Name ?? ""]" class="scene-image" loading="lazy" />
            <figcaption>@Localizer["SceneFacade", Model.Color.Number]</figcaption>
        </figure>
        <figure class="scene-preview">
            <img src="/images/ral-scenes/@(Model.Color.Slug)/side.jpg" alt="@Localizer["SceneSideAlt", Model.Color.Number, Model.Color.Name ?? ""]" class="scene-image" loading="lazy" />
            <figcaption>@Localizer["SceneFacade", Model.Color.Number]</figcaption>
        </figure>
        <figure class="scene-preview">
            <img src="/images/ral-scenes/@(Model.Color.Slug)/terrace.jpg" alt="@Localizer["SceneTerraceAlt", Model.Color.Number, Model.Color.Name ?? ""]" class="scene-image" loading="lazy" />
            <figcaption>@Localizer["SceneTerrace", Model.Color.Number]</figcaption>
        </figure>
        <figure class="scene-preview">
            <img src="/images/ral-scenes/@(Model.Color.Slug)/window.jpg" alt="@Localizer["SceneWindowAlt", Model.Color.Number, Model.Color.Name ?? ""]" class="scene-image" loading="lazy" />
            <figcaption>@Localizer["SceneWindow", Model.Color.Number]</figcaption>
        </figure>
    </div>
</section>


<section class="color-share-section mt-2xl">
    <h2>@Localizer["ColorImageTitle", Model.Color.Number]</h2>
    <figure class="color-share-image">
        <img src="/images/ral-colors/@(Model.Color.Slug).jpg"
             alt="@(string.IsNullOrEmpty(Model.Color.Name)
                      ? Localizer["ImageAltBasic", Model.Color.Number, Model.Color.Hex].Value
                      : Localizer["ImageAltWithName", Model.Color.Number, Model.Color.Name, Model.Color.Hex].Value)"
             width="1200"
             height="630"
             loading="lazy" />
        <figcaption>
            <button class="btn btn-sm btn-secondary copy-url-btn"
                    data-url="@baseUrl/images/ral-colors/@(Model.Color.Slug).jpg"
                    data-copied-text="@Localizer["CopiedToClipboard"]"
                    onclick="copyImageUrl(this)">
                @Localizer["CopyImageUrl"]
            </button>
        </figcaption>
    </figure>
</section>

<section class="contrast-section mt-4xl">
    <h2>@Localizer["ContrastComparison", Model.Color.Number]</h2>
    <div class="contrast-grid">
        <div class="contrast-bg" style="background-color: #FFFFFF;"
             role="button" tabindex="0"
             onclick="openColorPreviewWithBg('#FFFFFF')" onkeydown="handleContrastKeydown(event, '#FFFFFF')">
            <div class="contrast-swatch" style="background-color: @Model.Color.Hex;"></div>
            <span class="contrast-label">@Localizer["BgWhite"]</span>
        </div>
        <div class="contrast-bg" style="background-color: #E0E0E0;"
             role="button" tabindex="0"
             onclick="openColorPreviewWithBg('#E0E0E0')" onkeydown="handleContrastKeydown(event, '#E0E0E0')">
            <div class="contrast-swatch" style="background-color: @Model.Color.Hex;"></div>
            <span class="contrast-label">@Localizer["BgLightGrey"]</span>
        </div>
        <div class="contrast-bg" style="background-color: #9E9E9E;"
             role="button" tabindex="0"
             onclick="openColorPreviewWithBg('#9E9E9E')" onkeydown="handleContrastKeydown(event, '#9E9E9E')">
            <div class="contrast-swatch" style="background-color: @Model.Color.Hex;"></div>
            <span class="contrast-label">@Localizer["BgGrey"]</span>
        </div>
        <div class="contrast-bg" style="background-color: #424242;"
             role="button" tabindex="0"
             onclick="openColorPreviewWithBg('#424242')" onkeydown="handleContrastKeydown(event, '#424242')">
            <div class="contrast-swatch" style="background-color: @Model.Color.Hex;"></div>
            <span class="contrast-label">@Localizer["BgDarkGrey"]</span>
        </div>
        <div class="contrast-bg" style="background-color: #000000;"
             role="button" tabindex="0"
             onclick="openColorPreviewWithBg('#000000')" onkeydown="handleContrastKeydown(event, '#000000')">
            <div class="contrast-swatch" style="background-color: @Model.Color.Hex;"></div>
            <span class="contrast-label">@Localizer["BgBlack"]</span>
        </div>
    </div>
</section>


@{
    // Get similar colors from the same category/palette (up to 10)
    var sameCategoryColors = Model.Color.Category switch
    {
        RalCategory.Classic => Model.SimilarColors.Classic,
        RalCategory.DesignPlus => Model.SimilarColors.DesignPlus,
        RalCategory.Effect => Model.SimilarColors.Effect,
        _ => Model.SimilarColors.Classic
    };
    var compareColors = sameCategoryColors.Take(10).ToList();
}

@if (compareColors.Any())
{
    <section class="compare-links mt-4xl">
        <h2>@Localizer["CompareWith", Model.Color.Number, Model.Color.Name ?? ""]</h2>
        <div class="compare-links-grid">
            @foreach (var similar in compareColors)
            {
                <a asp-page="/ral-colors/Versus" asp-route-culture="@currentCulture"
                   asp-route-slug="@Model.Color.Slug-vs-@similar.Color.Slug" class="compare-link">
                    <span class="compare-link-swatches">
                        <span class="compare-link-swatch" style="background-color: @Model.Color.Hex;"></span>
                        <span class="compare-link-swatch" style="background-color: @similar.Color.Hex;"></span>
                    </span>
                    <span class="compare-link-label">RAL @Model.Color.Number vs @similar.Color.Number</span>
                </a>
            }
        </div>
    </section>
}

@if (Model.SimilarColors.Classic.Any() || Model.SimilarColors.DesignPlus.Any() || Model.SimilarColors.Effect.Any())
{
    <section class="similar-colors mt-4xl">
        <h2>@Localizer["SimilarColors", Model.Color.Number]</h2>

        @if (Model.SimilarColors.Classic.Any())
        {
            <h3>@Localizer["CategoryClassic"]</h3>
            <div class="similar-grid">
                @foreach (var similar in Model.SimilarColors.Classic)
                {
                    <partial name="_ColorTile" model="similar.Color" />
                }
            </div>
        }

        @if (Model.SimilarColors.DesignPlus.Any())
        {
            <h3>@Localizer["CategoryDesignPlus"]</h3>
            <div class="similar-grid">
                @foreach (var similar in Model.SimilarColors.DesignPlus)
                {
                    <partial name="_ColorTile" model="similar.Color" />
                }
            </div>
        }

        @if (Model.SimilarColors.Effect.Any())
        {
            <h3>@Localizer["CategoryEffect"]</h3>
            <div class="similar-grid">
                @foreach (var similar in Model.SimilarColors.Effect)
                {
                    <partial name="_ColorTile" model="similar.Color" />
                }
            </div>
        }
    </section>
}

<section class="color-codes-section mt-4xl">
    <h2>@Localizer["ColorCodesTitle", Model.Color.Number]</h2>
    <table class="color-details">
        <tr>
            <th>@Localizer["LabelName"]</th>
            <td>@(string.IsNullOrEmpty(Model.Color.Name) ? "—" : Model.Color.Name)</td>
        </tr>
        <tr>
            <th>@Localizer["LabelNameDe"]</th>
            <td>@(string.IsNullOrEmpty(Model.Color.NameDe) ? "—" : Model.Color.NameDe)</td>
        </tr>
        <tr>
            <th>@Localizer["LabelRootColor"]</th>
            <td>
                @if (Model.Color.RootColor != RootColor.Unknown)
                {
                    <span class="badge badge-@Model.Color.RootColor.ToString().ToLowerInvariant()">
                        @Localizer[$"RootColor{Model.Color.RootColor}"]
                    </span>
                }
                else
                {
                    <span>—</span>
                }
            </td>
        </tr>
        <tr>
            <th>@Localizer["LabelHex"]</th>
            <td>@Model.Color.Hex</td>
        </tr>
        <tr>
            <th>@Localizer["LabelRgbValues"]</th>
            <td>@Model.Formats?.Rgb.R, @Model.Formats?.Rgb.G, @Model.Formats?.Rgb.B</td>
        </tr>
        <tr>
            <th>@Localizer["LabelRgbPercent"]</th>
            <td>@Model.Formats?.RgbPercentString</td>
        </tr>
        <tr>
            <th>@Localizer["LabelHsv"]</th>
            <td>@Model.Formats?.HsvString</td>
        </tr>
        <tr>
            <th>@Localizer["LabelHsl"]</th>
            <td>@Model.Formats?.HslString</td>
        </tr>
        <tr>
            <th>@Localizer["LabelCmyk"]</th>
            <td>@Model.Formats?.CmykString</td>
        </tr>
        <tr>
            <th>@Localizer["LabelYiq"]</th>
            <td>@Model.Formats?.YiqString</td>
        </tr>
        <tr>
            <th>@Localizer["LabelXyz"]</th>
            <td>@Model.Formats?.XyzString</td>
        </tr>
        <tr>
            <th>@Localizer["LabelCieLab"]</th>
            <td>@Model.Formats?.LabString</td>
        </tr>
        <tr>
            <th>@Localizer["LabelCieLuv"]</th>
            <td>@Model.Formats?.LuvString</td>
        </tr>
        <tr>
            <th>@Localizer["LabelDecimal"]</th>
            <td>@Model.Formats?.Decimal</td>
        </tr>
        <tr>
            <th>@Localizer["LabelHunterLab"]</th>
            <td>@Model.Formats?.HunterLabString</td>
        </tr>
    </table>
</section>

<a asp-page="/ral-colors/Index" class="btn btn-ghost mt-xl" asp-route-culture="@RouteData.Values["culture"]">
    &larr; @Localizer["BackToColors"]
</a>

@section Scripts {
    <script>
        let lastFocusedElement = null;

        function openColorPreview() {
            lastFocusedElement = document.activeElement;
            const modal = document.getElementById('colorPreview');
            modal.classList.add('active', 'fullscreen');
            document.body.style.overflow = 'hidden';
            modal.querySelector('.color-preview-close').focus();
        }

        function openColorPreviewWithBg(bgColor) {
            const modal = document.getElementById('colorPreview');
            modal.style.backgroundColor = bgColor;
            document.querySelectorAll('.bg-option').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.bg === bgColor);
            });
            lastFocusedElement = document.activeElement;
            modal.classList.add('active');
            modal.classList.remove('fullscreen');
            document.body.style.overflow = 'hidden';
            modal.querySelector('.color-preview-close').focus();
        }

        function closeColorPreview(event) {
            if (event.target.classList.contains('color-preview-overlay') ||
                event.target.classList.contains('color-preview-fullscreen') ||
                event.target.classList.contains('color-preview-close')) {
                closeModal();
            }
        }

        function closeModal() {
            const modal = document.getElementById('colorPreview');
            modal.classList.remove('active', 'fullscreen');
            document.body.style.overflow = '';
            if (lastFocusedElement) lastFocusedElement.focus();
        }

        function changePreviewBg(color, button) {
            document.getElementById('colorPreview').style.backgroundColor = color;
            document.querySelectorAll('.bg-option').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            event.stopPropagation();
        }

        function handleColorKeydown(event) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                openColorPreview();
            }
        }

        function handleContrastKeydown(event, bgColor) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                openColorPreviewWithBg(bgColor);
            }
        }

        // Focus trap for modal
        document.getElementById('colorPreview').addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                const focusable = this.querySelectorAll('button:not([style*="display: none"])');
                const first = focusable[0];
                const last = focusable[focusable.length - 1];

                if (e.shiftKey && document.activeElement === first) {
                    e.preventDefault();
                    last.focus();
                } else if (!e.shiftKey && document.activeElement === last) {
                    e.preventDefault();
                    first.focus();
                }
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Copy image URL to clipboard
        function copyImageUrl(button) {
            const url = button.dataset.url;
            const originalText = button.textContent;
            const copiedText = button.dataset.copiedText;

            navigator.clipboard.writeText(url).then(function() {
                button.textContent = copiedText;
                button.disabled = true;
                setTimeout(function() {
                    button.textContent = originalText;
                    button.disabled = false;
                }, 2000);
            });
        }
    </script>
}

<!-- Full-page color preview modal -->
<div id="colorPreview" class="color-preview-overlay" style="background-color: #FFFFFF;"
     role="dialog" aria-modal="true" aria-labelledby="colorPreviewTitle"
     onclick="closeColorPreview(event)">
    <h2 id="colorPreviewTitle" class="visually-hidden">@Localizer["ColorPreviewTitle"]</h2>
    <button class="color-preview-close" onclick="closeColorPreview(event)" aria-label="@Localizer["Close"]">&times;</button>
    <div class="color-preview-content">
        <div class="color-preview-swatch" style="background-color: @Model.Color.Hex;"></div>
    </div>
    <div class="color-preview-controls">
        <button class="bg-option active" data-bg="#FFFFFF" onclick="changePreviewBg('#FFFFFF', this)">
            <span class="bg-option-swatch" style="background-color: #FFFFFF;"><span style="background-color: @Model.Color.Hex;"></span></span>
            <span class="bg-option-label">@Localizer["BgWhite"]</span>
        </button>
        <button class="bg-option" data-bg="#E0E0E0" onclick="changePreviewBg('#E0E0E0', this)">
            <span class="bg-option-swatch" style="background-color: #E0E0E0;"><span style="background-color: @Model.Color.Hex;"></span></span>
            <span class="bg-option-label">@Localizer["BgLightGrey"]</span>
        </button>
        <button class="bg-option" data-bg="#9E9E9E" onclick="changePreviewBg('#9E9E9E', this)">
            <span class="bg-option-swatch" style="background-color: #9E9E9E;"><span style="background-color: @Model.Color.Hex;"></span></span>
            <span class="bg-option-label">@Localizer["BgGrey"]</span>
        </button>
        <button class="bg-option" data-bg="#424242" onclick="changePreviewBg('#424242', this)">
            <span class="bg-option-swatch" style="background-color: #424242;"><span style="background-color: @Model.Color.Hex;"></span></span>
            <span class="bg-option-label">@Localizer["BgDarkGrey"]</span>
        </button>
        <button class="bg-option" data-bg="#000000" onclick="changePreviewBg('#000000', this)">
            <span class="bg-option-swatch" style="background-color: #000000;"><span style="background-color: @Model.Color.Hex;"></span></span>
            <span class="bg-option-label">@Localizer["BgBlack"]</span>
        </button>
    </div>
    <!-- Fullscreen mode: color fills entire overlay -->
    <div class="color-preview-fullscreen" style="background-color: @Model.Color.Hex;"></div>
</div>
