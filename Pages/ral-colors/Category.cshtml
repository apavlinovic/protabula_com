@page "/ral-colors/{category:regex(^(classic|design-plus|effect)$)}/{rootColor?}"
@using Microsoft.AspNetCore.Mvc.Localization
@using System.Globalization
@using protabula_com.Models
@inject IViewLocalizer Localizer
@model CategoryModel
@{
    var categoryKey = Model.Category?.ToString() ?? "";
    var culture = CultureInfo.CurrentUICulture.Name;
    var currentCulture = culture;
    var request = ViewContext.HttpContext.Request;
    var baseUrl = $"{request.Scheme}://{request.Host}";

    var categorySlug = Model.Category switch
    {
        RalCategory.Classic => "classic",
        RalCategory.DesignPlus => "design-plus",
        RalCategory.Effect => "effect",
        _ => ""
    };
    var rootColorSlug = Model.SelectedRootColor?.ToString().ToLowerInvariant();

    var categoryName = Localizer[$"Title{categoryKey}"].Value;
    var rootColorName = Model.SelectedRootColor.HasValue
        ? Localizer[$"RootColor{Model.SelectedRootColor}"].Value
        : null;

    // Page title: "RAL Classic Colors" or "RAL Classic Grey Colors"
    ViewData["Title"] = Model.SelectedRootColor.HasValue && rootColorName != null
        ? Localizer["TitleFiltered", categoryName, rootColorName].Value
        : categoryName;

    ViewData["MetaDescription"] = Model.SelectedRootColor.HasValue && rootColorName != null
        ? Localizer["MetaDescriptionFiltered", categoryName, rootColorName].Value
        : Localizer[$"MetaDescription{categoryKey}"].Value;

    var breadcrumbs = new List<(string, string?, object?)>
    {
        (Localizer["BreadcrumbColors"].Value, "/ral-colors/Index", new Dictionary<string, string> { ["culture"] = culture }),
        (categoryName, "/ral-colors/Category", new Dictionary<string, string> { ["culture"] = culture, ["category"] = categorySlug })
    };
    if (Model.SelectedRootColor.HasValue)
    {
        breadcrumbs.Add((rootColorName!, null, null));
    }
    else
    {
        // Remove the link from last breadcrumb when not filtered
        breadcrumbs[^1] = (categoryName, null, null);
    }
    ViewData["Breadcrumbs"] = breadcrumbs;
}

@section Head {
    <script type="application/ld+json">
    {
        "@@context": "https://schema.org",
        "@@type": "CollectionPage",
        "name": "@ViewData["Title"]",
        "description": "@ViewData["MetaDescription"]",
        "url": "@baseUrl/@currentCulture/ral-colors/@categorySlug@(rootColorSlug != null ? $"/{rootColorSlug}" : "")",
        "isPartOf": {
            "@@type": "WebSite",
            "name": "Protabula",
            "url": "@baseUrl"
        },
        "about": {
            "@@type": "Thing",
            "name": "@ViewData["Title"]"
        },
        "numberOfItems": @Model.Colors.Count
    }
    </script>
}

<h1>@ViewData["Title"]</h1>
<p>@Localizer[$"Intro{categoryKey}"]</p>
<p class="text-secondary">
    <a asp-page="/ral-colors/Guide" asp-route-culture="@currentCulture" class="text-link">
        @Localizer["GuideCta"]
    </a>
</p>

@if (Model.AvailableRootColors.Count > 1)
{
    <nav class="root-color-filters" aria-label="@Localizer["FilterByRootColor"]">
        <a href="/@currentCulture/ral-colors/@categorySlug"
           class="filter-chip @(Model.SelectedRootColor == null ? "active" : "")">
            @Localizer["FilterAll"]
        </a>
        @foreach (var rootColor in Model.AvailableRootColors)
        {
            var chipSlug = rootColor.ToString().ToLowerInvariant();
            <a asp-page="/ral-colors/Category"
               asp-route-culture="@currentCulture"
               asp-route-category="@categorySlug"
               asp-route-rootColor="@chipSlug"
               class="filter-chip @(Model.SelectedRootColor == rootColor ? "active" : "")">
                @Localizer[$"RootColor{rootColor}"]
            </a>
        }
    </nav>
}

<partial name="Shared/_ColorFilter" />

<div class="color-grid">
    @foreach (var color in Model.Colors)
    {
        <a class="color-tile @(color.NeedsDarkText ? "dark" : "")" style="background-color: @color.Hex;"
           asp-page="/ral-colors/Details" asp-route-culture="@RouteData.Values["culture"]"
           asp-route-colorIdentifier="@color.Slug"
           data-name="@color.Name?.ToLowerInvariant()"
           data-name-de="@color.NameDe?.ToLowerInvariant()"
           data-number="@color.Number.ToLowerInvariant()">

            <span class="ral">RAL</span>
            <h3 class="number">@color.Number</h3>

            @{
                var localizedName = color.GetLocalizedName(currentCulture);
            }
            @if (!string.IsNullOrEmpty(localizedName))
            {
                <span class="name">@localizedName</span>
            }
        </a>
    }
</div>

<p id="noResults" class="text-secondary hidden">@Localizer["NoResults"]</p>

@section Scripts {
    <script>
        function filterColors(query) {
            const searchTerm = query.toLowerCase().trim();
            const tiles = document.querySelectorAll('.color-tile');
            const noResults = document.getElementById('noResults');

            let totalVisible = 0;

            tiles.forEach(tile => {
                const name = tile.dataset.name || '';
                const nameDe = tile.dataset.nameDe || '';
                const number = tile.dataset.number || '';

                const matches = searchTerm === '' ||
                    name.includes(searchTerm) ||
                    nameDe.includes(searchTerm) ||
                    number.includes(searchTerm);

                tile.style.display = matches ? '' : 'none';
                if (matches) totalVisible++;
            });

            noResults.classList.toggle('hidden', !(totalVisible === 0 && searchTerm !== ''));
        }
    </script>
}
